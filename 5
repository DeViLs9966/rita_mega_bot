import os
import re
from dotenv import load_dotenv
from telegram import Bot
import requests

ENV_PATH = ".env"

def clean_token(token):
    """–£–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã"""
    return token.replace(" ", "").replace("\n", "").strip()

def load_and_fix_env():
    print("üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env...")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    load_dotenv(ENV_PATH)
    token = os.getenv("TELEGRAM_BOT_TOKEN", "")
    fixed_token = clean_token(token)

    if not fixed_token or ":" not in fixed_token:
        print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –æ—Ç @BotFather.")
        return None

    if token != fixed_token:
        print("‚ö†Ô∏è –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ —Å–∏–º–≤–æ–ª—ã ‚Äî –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...")

        # –ß–∏—Ç–∞–µ–º –∏ –ø—Ä–∞–≤–∏–º —Ñ–∞–π–ª .env
        with open(ENV_PATH, "r", encoding="utf-8") as f:
            lines = f.readlines()

        with open(ENV_PATH, "w", encoding="utf-8") as f:
            for line in lines:
                if line.startswith("TELEGRAM_BOT_TOKEN"):
                    f.write(f'TELEGRAM_BOT_TOKEN={fixed_token}\n')
                else:
                    f.write(line)

        print("‚úÖ –¢–æ–∫–µ–Ω –≤ .env –∏—Å–ø—Ä–∞–≤–ª–µ–Ω.")

    return fixed_token

def test_telegram_token(token):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ Telegram API"""
    url = f"https://api.telegram.org/bot{token}/getMe"
    try:
        response = requests.get(url, timeout=10)
        if response.ok:
            data = response.json()
            if data.get("ok"):
                print(f"‚úÖ –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ë–æ—Ç: @{data['result']['username']}")
                return True
            else:
                print("‚ùå –û—Ç–≤–µ—Ç Telegram API: –æ—à–∏–±–∫–∞:", data.get("description"))
        else:
            print(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status_code}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Telegram API: {e}")
    return False

if __name__ == "__main__":
    print("üõ†Ô∏è –ó–∞–ø—É—Å–∫ fix_token_issue.py")
    token = load_and_fix_env()
    if token:
        test_telegram_token(token)
    else:
        print("üö´ –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω.")
