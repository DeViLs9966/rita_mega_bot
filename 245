import os
import sys
import re
import shutil

FILENAME = sys.argv[1] if len(sys.argv) > 1 else "check_bot_diagnostics.py"

# üõ°Ô∏è Backup original
backup_name = FILENAME + ".bak"
shutil.copyfile(FILENAME, backup_name)
print(f"[BACKUP] –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫: {backup_name}")

with open(FILENAME, "r", encoding="utf-8") as f:
    lines = f.readlines()

patched = []
main_block_found = False
inside_main_block = False

for i, line in enumerate(lines):
    # –£–¥–∞–ª—è–µ–º .close_loop()
    if ".close_loop(" in line:
        print(f"[FIX] –£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å .close_loop(): {line.strip()}")
        continue

    # –ó–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
    if re.match(r"if\s+__name__\s*==\s*[\"']__main__[\"']\s*:", line):
        main_block_found = True
        inside_main_block = True
        patched.append('if __name__ == "__main__":\n')
        patched.append('    import nest_asyncio\n')
        patched.append('    import asyncio\n')
        patched.append('    import signal\n\n')
        patched.append('    nest_asyncio.apply()\n')
        patched.append('    loop = asyncio.get_event_loop()\n')
        patched.append('    for sig in (signal.SIGINT, signal.SIGTERM):\n')
        patched.append('        try:\n')
        patched.append('            loop.add_signal_handler(sig, loop.stop)\n')
        patched.append('        except NotImplementedError:\n')
        patched.append('            pass\n\n')
        patched.append('    try:\n')
        patched.append('        loop.run_until_complete(main_wrapper())\n')
        patched.append('    except KeyboardInterrupt:\n')
        patched.append('        logger.info("üö™ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ Ctrl+C")\n')
        patched.append('    except Exception as e:\n')
        patched.append('        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")\n')
        patched.append('    finally:\n')
        patched.append('        if not loop.is_closed():\n')
        patched.append('            try:\n')
        patched.append('                loop.close()\n')
        patched.append('            except Exception:\n')
        patched.append('                pass\n')
        continue

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
    if inside_main_block and (line.startswith("    ") or line.strip() == ""):
        continue
    else:
        inside_main_block = False

    patched.append(line)

# üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
with open(FILENAME, "w", encoding="utf-8") as f:
    f.writelines(patched)

print(f"[‚úÖ] –ü–∞—Ç—á —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω –∫ '{FILENAME}'")
